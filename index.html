<!-- Inclusion Support Documentation - Submit Version -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inclusion Support Documentation - Submit</title>
<style>
/* --- Injected by ChatGPT: hide legacy download buttons --- */
#downloadCsvBtn, #downloadJSONBtn, #downloadJsonBtn, button[data-action="download-csv"], button[data-action="download-json"] {
  display: none !important;
}
</style>
</head>
<body>
<!-- Header bar with date and submit button -->
<header>
  <div class="bar">
    <div class="brand">Inclusion Support — <strong>Jesse Ritter</strong></div>
    <div class="spacer"></div>
    <div class="field">
      <label for="date">Date</label>
      <input id="date" type="date" />
      <button id="is-submit-btn" class="btn" type="button">Submit</button>
      <span id="is-submit-status" style="margin-left:10px;font-weight:700;color:#4A7A92;"></span>
    </div>
  </div>
</header>

<script>
(function(){
  // ====== CONFIG ======
  const WEBAPP_URL = "https://script.google.com/a/macros/wawasee.k12.in.us/s/AKfycbyg7IQ9H2XVRRP_sXGcBNUXNdPD9hWkqAfY5eNS2wYnMttSZWVL5uaty6auyCMF45PC/exec";
  const WEBAPP_TOKEN = "CHANGE_ME_TO_MATCH_APPS_SCRIPT"; // must match SHARED_TOKEN in Apps Script

  function safe(fn, fallback) { try { return fn(); } catch(e){ return fallback; } }
  const todayStr = safe(()=>window.todayStr, ()=>{
    const d=new Date(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${m}-${da}`;
  });

  async function submitToDrive(){
    const btn = document.getElementById('is-submit-btn');
    const statusEl = document.getElementById('is-submit-status');
    try {
      if (btn) btn.disabled = true;
      if (statusEl) statusEl.textContent = "Submitting…";

      const dateInput = document.getElementById('date') || document.querySelector('input[type="date"]');
      const date = (dateInput && dateInput.value) ? dateInput.value : todayStr();

      const classes = window.CLASSES || [];
      const key = window.currentClassKey || (classes[0] ? classes[0].key : "");
      const cls = classes.find(c => c.key === key) || classes[0] || {};
      const rows = (typeof window.loadData === "function") ? window.loadData(date, cls) : [];

      const payload = {
        token: WEBAPP_TOKEN,
        date,
        teacher: window.TEACHER || "Jesse Ritter",
        class_period: cls.class_period || "",
        class_course: cls.class_course || "",
        class_teacher: cls.class_teacher || "",
        class_key: cls.key || "",
        students: rows || []
      };

      const res = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));

      if (data && data.ok) {
        if (statusEl) statusEl.textContent = "Saved to Drive";
      } else {
        if (statusEl) statusEl.textContent = "Save failed";
        alert("Save failed: " + (data && data.error ? data.error : "Unknown error"));
      }
    } catch (err) {
      if (statusEl) statusEl.textContent = "Network error";
      console.error(err);
      alert('Network error while submitting.');
    } finally {
      if (btn) btn.disabled = false;
      setTimeout(()=>{ if (statusEl) statusEl.textContent=""; }, 3500);
    }
  }

  document.getElementById('is-submit-btn').addEventListener('click', submitToDrive);
})();
</script>
</body>
</html>
