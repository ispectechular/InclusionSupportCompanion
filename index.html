<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inclusion Logger</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue-700: #4A7A92;
      --blue-500: #5A94B1;
      --green-600: #879B8D;
      --input-bg: #fff;
      --input-bd: rgba(90,148,177,0.35);
      --shadow-light: rgba(0, 0, 0, 0.05);
      --toast-success: #1a7f37;
      --toast-error: #b42318;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Lexend', system-ui, -apple-system, Segoe UI, Roboto; }

    body { background: #fff; color: #10151b; }

    header { background: #fff; box-shadow: 0 2px 10px var(--shadow-light); padding: 20px; text-align: center; position: sticky; top: 0; z-index: 10; }
    header h1 { font-size: 1.8rem; font-weight: 800; color: var(--blue-700); letter-spacing: 0.5px; }

    .bar { max-width: 1100px; margin: 20px auto; display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; padding: 0 16px; }
    .toolbar .left{display:flex;align-items:center;gap:10px;flex:1;min-width:300px}
    .toolbar .right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    label { color: var(--green-600); font-weight: 600; }

    input[type=date], .btn { background: var(--input-bg); border: 1px solid var(--input-bd); padding: 12px 16px; border-radius: 12px; font: inherit; line-height: 1.2; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    input[type=date]:focus, .btn:focus { outline: none; border-color: var(--blue-500); box-shadow: 0 0 0 3px rgba(90,148,177,0.15); }

    .btn { cursor: pointer; font-weight: 700; background: var(--blue-700); color: #fff; width: fit-content; min-width: 180px; text-align: center; }
    .btn:hover { background: var(--blue-500); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(74,122,146,0.25); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; transform: none; box-shadow: none; }

    main { max-width: 1100px; margin: 0 auto; padding: 20px; }

    .tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 24px; justify-content: center; }
    .tab { appearance: none; border: none; outline: none; cursor: pointer; padding: 12px 24px; border-radius: 999px; font-weight: 700; transition: all .2s ease; background: #f8f9fa; border: 1px solid rgba(90,148,177,.35); color: #152028; box-shadow: 0 2px 4px rgba(0,0,0,.04); }
    .tab:hover { background: #eef3f5; transform: translateY(-1px); }
    .tab.active { background: var(--blue-700); color: #fff; border-color: transparent; box-shadow: 0 6px 16px rgba(74,122,146,.25); transform: translateY(-2px); }

    .survey { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .person { display: grid; gap: 10px; background: #fafafa; border: 1px solid rgba(74,122,146,.16); border-radius: 16px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,.03); transition: transform 0.15s ease, box-shadow 0.15s ease; }
    .person:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,.06); }
    .person h3 { margin: 0; font-size: 1rem; color: #333; }
    .options { display: grid; gap: 8px; }
    .opt { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid rgba(90,148,177,0.25); background: #fff; border-radius: 12px; cursor: pointer; color: #0b0f13; font-weight: 600; transition: all .15s ease; }
    .opt input { width: 18px; height: 18px; }
    .opt:hover { background: #f0f6f8; color: var(--blue-700); }
    .note { width: 100%; background: #fff; border: 1px solid rgba(90,148,177,0.25); border-radius: 12px; padding: 8px 10px; font: inherit; }

    .toast-container { position: fixed; right: 16px; top: 16px; display: grid; gap: 8px; z-index: 9999; }
    .toast { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 10px; background: #111; color: #fff; box-shadow: 0 8px 20px rgba(0,0,0,.18); opacity: 0; transform: translateY(-6px); transition: opacity .25s ease, transform .25s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--toast-success); }
    .toast.error { background: var(--toast-error); }
  </style>
</head>
<body>
  <header><h1>Inclusion Logger</h1></header>

  <div class="bar toolbar">
    <div class="left">
      <div id="tabs" class="tabs"></div>
    </div>
    <div class="right">
      <div class="field">
        <label for="date">Date</label>
        <input id="date" type="date" />
      </div>
      <button class="btn" id="submitCsvBtn">Submit</button>
      <span id="submitStatus" style="font-weight:700;margin-left:8px;"></span>
    </div>
  </div>

  <main>
    <div id="survey" class="survey"></div>
  </main>

  <div class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <script>
  // === DATA ===
  const CLASSES = [
    {key:'6th-Algebra1-Hoffert',class_period:'6th',class_course:'Algebra 1',class_teacher:'Hoffert',students:['Deklyn Sizemore','Isaiah Schmerber','Julia McFarland','Madison Wilson','Mason Maggert','Riley Rohrbaugh','Trinity Smith','Xander Bowers','Zoey Schuller']},
    {key:'7th-Geometry-Mikel',class_period:'7th',class_course:'Geometry',class_teacher:'Mikel',students:['Abigail Zakutanksy','Adrian Barrientos','Austin Cripe','Deklan Hawthorne','Guadalupe Jimenez Rodriguez','Jessa Sprague','Joseph Dunfee','Lillie Gerke','Logan Rasler','Natasha Cartwright','Ethan Stufflebeam','Wyatt Sayler']}
  ];
  const TEACHER = 'Jesse Ritter';

  // Expose to window for later helper scripts
  window.CLASSES = CLASSES;
  window.TEACHER = TEACHER;

  // === HELPERS ===
  let currentClassKey = CLASSES[0].key; // default first tab
  window.currentClassKey = currentClassKey; // keep in sync for submit helpers

  const $ = s => document.querySelector(s);
  const el = (t,a={},c=[])=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')n.className=v;else if(k.startsWith('on'))n.addEventListener(k.slice(2),v);else if(k==='text')n.textContent=v;else n.setAttribute(k,v);}([]).concat(c).forEach(x=>n.append(x?.nodeType?x:document.createTextNode(x)));return n;};
  const todayStr=()=>new Date().toISOString().slice(0,10);

  function initDate(){const d=$('#date');d.value=todayStr();d.addEventListener('change',renderAll);}

  function initTabs(){
    const tabs=$('#tabs');tabs.innerHTML='';
    CLASSES.forEach(c=>{
      const b=el('button',{class:'tab'+(c.key===currentClassKey?' active':''),onclick:()=>{currentClassKey=c.key; window.currentClassKey=currentClassKey; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAll();}},`Period ${c.class_period.replace(/\D/g,'')}: ${c.class_course}`);
      tabs.appendChild(b);
    });
  }

  function defaultRows(cls){
    return cls.students.map(n=>({
      student:n,
      WI:false, RH:false, AH:false, AFH:false, O:false, Ab:false,
      other_note:''
    }));
  }

  function renderAll(){
    const date=$('#date').value||todayStr();
    const cls=CLASSES.find(c=>c.key===currentClassKey);
    renderSurvey(defaultRows(cls),cls,date);
  }

  function renderSurvey(rows,cls,date){
    const host=$('#survey');host.innerHTML='';
    rows.forEach(r=>{
      const card=el('div',{class:'person','data-student': r.student});
      card.append(el('h3',{text:r.student}));
      const options=el('div',{class:'options'});
      const makeOpt=(label,key)=>{
        const id=`${cls.key}-${r.student}-${key}`.replace(/\s+/g,'_');
        const input=document.createElement('input');
        input.type='checkbox'; input.id=id; input.dataset.key=key; input.checked=r[key]===true;
        const lbl=el('label',{class:'opt',for:id},[input,label]);
        return lbl;
      };
      options.append(
        makeOpt('Worked Independently','WI'),
        makeOpt('Refused Help','RH'),
        makeOpt('Accepted Help','AH'),
        makeOpt('Asked for Help','AFH'),
        makeOpt('Other','O'),
        makeOpt('Absent','Ab')
      );
      const note=el('input',{class:'note',type:'text',placeholder:'Other note (optional)','data-key':'other_note'});
      card.append(options,note);host.append(card);
    });
  }

  // --- Inline smoke tests (do not change UI) ---
  (function runTests(){
    try{
      console.assert(Array.isArray(window.CLASSES) && window.CLASSES.length>=2, 'CLASSES should be exposed on window');
      console.assert(typeof window.currentClassKey==='string' && window.currentClassKey.length>0, 'currentClassKey should be on window');
    }catch(e){ console.warn('Inline tests skipped:', e); }
  })();

  initDate();initTabs();renderAll();
  </script>

  <!-- Submit + Toast helpers -->
  <script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzcJBXkcVEk6WMErODNIlXQfn6GHqSIYIX30g5ui1yDyhbHM-S-JWtyvN3NEbYEwR4m/exec';

  function showToast(msg, type='success') {
    const c = document.querySelector('.toast-container'); if (!c) return;
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    c.appendChild(t);
    requestAnimationFrame(() => t.classList.add('show'));
    setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 220); }, 2500);
  }

  function collectRowsFromDOM(cls) {
    return [...document.querySelectorAll('.person')].map(card => {
      const student = card.getAttribute('data-student') || card.querySelector('h3')?.textContent || '';
      const get = key => card.querySelector(`input[data-key="${key}"]`)?.checked || false;
      const other = card.querySelector('input[data-key="other_note"]')?.value || '';
      return { student, WI:get('WI'), RH:get('RH'), AH:get('AH'), AFH:get('AFH'), O:get('O'), Ab:get('Ab'), other_note: other };
    });
  }

  function getCsvString() {
    const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
    const classesSource = window.CLASSES || [];
    const fallbackCls = (Array.isArray(classesSource) && classesSource.length>0) ? classesSource[0] : (typeof CLASSES!=='undefined'? CLASSES[0]: null);
    const cls = (classesSource.find?.(c => c.key === window.currentClassKey)) || fallbackCls;
    if(!cls){ throw new Error('Classes not initialized'); }

    const rows = collectRowsFromDOM(cls);
    let csv = "date,class_period,class_course,class_teacher,teacher,student,statuses,other_note\n";
    rows.forEach(r => {
      const statuses = [];
      if (r.WI)  statuses.push('Worked Independently');
      if (r.RH)  statuses.push('Refused Help');
      if (r.AH)  statuses.push('Accepted Help');
      if (r.AFH) statuses.push('Asked for Help');
      if (r.O)   statuses.push('Other');
      if (r.Ab)  statuses.push('Absent');
      const note = (r.other_note || '').replaceAll(',', ';');
      csv += `${date},${cls.class_period},${cls.class_course},${cls.class_teacher},${(window.TEACHER||'Jesse Ritter')},${r.student},${statuses.join('|')},${note}\n`;
    });
    return csv;
  }

  function buildFilename() {
    const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
    const classesSource = window.CLASSES || [];
    const fallbackCls = (Array.isArray(classesSource) && classesSource.length>0) ? classesSource[0] : (typeof CLASSES!=='undefined'? CLASSES[0]: null);
    const cls = (classesSource.find?.(c => c.key === window.currentClassKey)) || fallbackCls;
    const key = cls ? cls.key : 'Unknown';
    return `Inclusion_${key}-${date}.csv`.replace(/\s+/g,'_');
  }

  async function submitCsvToDrive() {
    const btn = document.getElementById('submitCsvBtn');
    const status = document.getElementById('submitStatus');
    if (!btn) return;

    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'Submitting…'; status.textContent = 'Submitting…';

    try {
      const csv = getCsvString();
      const payload = { csv, filename: buildFilename(), isoDate: new Date().toISOString() };
      const res = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify(payload) });
      const json = await res.json().catch(() => ({}));
      if (!json.ok) throw new Error(json.error || 'Upload failed');

      status.textContent = 'Saved to Drive ✔';
      showToast('Saved to Drive', 'success');
    } catch (err) {
      console.error(err);
      status.textContent = 'Upload failed — downloaded CSV instead';
      showToast('Upload failed — downloaded CSV', 'error');

      // Fallback: download locally
      const blob = new Blob([getCsvString()], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = buildFilename();
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    } finally {
      btn.disabled = false; btn.textContent = original;
    }
  }

  // Wire the click (after DOM is ready)
  document.getElementById('submitCsvBtn')?.addEventListener('click', submitCsvToDrive);

  // --- Minimal runtime tests for the submit helpers ---
  (function submitTests(){
    try{
      console.assert(Array.isArray(window.CLASSES) && window.CLASSES.length>0, 'window.CLASSES exists');
      const fn = buildFilename();
      console.assert(typeof fn==='string' && fn.includes('Inclusion_'), 'buildFilename returns a string');
    }catch(e){ console.warn('Submit helper tests skipped:', e); }
  })();
  </script>
</body>
</html>
